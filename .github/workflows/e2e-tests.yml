name: E2E Tests

on:
  workflow_call:  # Called by release workflow
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write  # needed for creating test tags

jobs:
  e2e:
    if: github.event_name != 'push' || github.ref_type != 'tag'
    runs-on: ubuntu-latest
    env:
      # Common tag prefix (matrix can override)
      TEST_TAG_PREFIX: ${{ matrix.tagPrefix || 'test-' }}
      # GitHub
      TEST_GITHUB_REPOSITORY: ${{ matrix.githubRepo || secrets.TEST_GITHUB_REPOSITORY || github.repository }}
      TEST_GITHUB_TOKEN: ${{ secrets.TEST_GITHUB_TOKEN || secrets.GITHUB_TOKEN || '' }}
      # Gitea
      TEST_GITEA_REPOSITORY: ${{ matrix.giteaRepo || secrets.TEST_GITEA_REPOSITORY || '' }}
      TEST_GITEA_TOKEN: ${{ secrets.TEST_GITEA_TOKEN || '' }}
      TEST_GITEA_BASE_URL: ${{ matrix.giteaBaseUrl || '' }}
      # Bitbucket
      TEST_BITBUCKET_REPOSITORY: ${{ matrix.bitbucketRepo || secrets.TEST_BITBUCKET_REPOSITORY || '' }}
      TEST_BITBUCKET_TOKEN: ${{ secrets.TEST_BITBUCKET_TOKEN || '' }}
      TEST_BITBUCKET_BASE_URL: ${{ matrix.bitbucketBaseUrl || '' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: github
            testPattern: github.e2e
            githubRepo: LiquidLogicLabs/git-action-release-tests
            tagPrefix: test-
          - platform: gitea
            testPattern: gitea.e2e
            giteaBaseUrl: https://git.ravenwolf.org
            giteaRepo: l3io/git-action-release-tests
            tagPrefix: test-
          # - platform: bitbucket
          #   testPattern: bitbucket.e2e
          #   bitbucketBaseUrl: https://bitbucket.org
          #   bitbucketRepo: owner/repo
          #   tagPrefix: test-
          - platform: generic
            testPattern: generic.e2e
            tagPrefix: test-
          - platform: git
            testPattern: generic.e2e
            tagPrefix: test-

    environment: TEST

    permissions:
      contents: write
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Prepare tag metadata
        id: prep
        run: |
          TAG_NAME="${{ matrix.tagPrefix || 'test-' }}${GITHUB_RUN_ID}-${{ matrix.platform }}-${GITHUB_RUN_ATTEMPT}"
          echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"

      - name: Resolve platform inputs
        id: resolve
        run: |
          set -euo pipefail
          run="true"
          repo=""
          token=""
          base_url=""
          case "${{ matrix.platform }}" in
            github)
              repo="${TEST_GITHUB_REPOSITORY}"
              token="${TEST_GITHUB_TOKEN}"
              if [ -z "$repo" ] || [ -z "$token" ]; then
                echo "⚠️ Skipping GitHub E2E: repo or token missing"
                run="false"
              fi
              ;;
            gitea)
              repo="${TEST_GITEA_REPOSITORY}"
              token="${TEST_GITEA_TOKEN}"
              base_url="${TEST_GITEA_BASE_URL}"
              if [ -z "$repo" ] || [ -z "$token" ]; then
                echo "⚠️ Skipping Gitea E2E: repo or token missing"
                run="false"
              fi
              ;;
            bitbucket)
              repo="${TEST_BITBUCKET_REPOSITORY}"
              token="${TEST_BITBUCKET_TOKEN}"
              base_url="${TEST_BITBUCKET_BASE_URL}"
              if [ -z "$repo" ] || [ -z "$token" ]; then
                echo "⚠️ Skipping Bitbucket E2E: repo or token missing"
                run="false"
              fi
              ;;
            generic|git)
              run="true"
              ;;
          esac
          echo "run=$run" >> "$GITHUB_OUTPUT"
          echo "repo=$repo" >> "$GITHUB_OUTPUT"
          echo "token=$token" >> "$GITHUB_OUTPUT"
          echo "base_url=$base_url" >> "$GITHUB_OUTPUT"

      - name: Run E2E via action (${{ matrix.platform }})
        if: steps.resolve.outputs.run == 'true'
        uses: ./
        with:
          tag_name: ${{ steps.prep.outputs.tag_name }}
          tag_message: E2E ${{ matrix.platform }} tag ${{ steps.prep.outputs.tag_name }}
          repository: ${{ steps.resolve.outputs.repo }}
          token: ${{ steps.resolve.outputs.token }}
          base_url: ${{ steps.resolve.outputs.base_url }}
          repo_type: ${{ matrix.platform }}
          force: true
          update_existing: false
          verbose: true
